import{j as e,r as f,G as u,h as j,I as L,ag as O,B as K,F as z,S as g,T as b,ar as k,a1 as T,z as Y,a8 as D,br as I,bs as G,K as S}from"./vendor-C5fHLTDD.js";import{T as x}from"./BaseContext-BGXKB9QI.js";import{i as n,A as F,l as M,j as B,n as X,t as P}from"./index-DX4YmBvQ.js";import{A as ee}from"./AddItemButton-BjrbTsCx.js";import{A as se,E as te,D as ie}from"./ActionDropdown-C-AjyTLr.js";import{I as c}from"./InfoItem-Blmt5-7-.js";import{I as re}from"./IconAlertCircle-C-1MzrG3.js";import{Y as Q}from"./YesNoButton-DIAHIY63.js";import{D as N,a as U}from"./DetailDrawer-UU2gEx54.js";import{b as ne,S as ae}from"./Instance-c0njg-mI.js";import{M as J}from"./SettingList-DDWUNgd-.js";import{h as le,p as oe,q as de}from"./ApiForm-Dtyf-xF2.js";import{a as ce}from"./UseForm-Btt47jru.js";import{u as R,I as V}from"./InvenTreeTable-LkhQVMZE.js";import{B as q}from"./ColumnRenderers-Dz-jxqgo.js";import{u as $}from"./DesktopAppView-DlNUv0Ur.js";import{I as A}from"./IconRefresh-ClXNAr2V.js";import"./ActionButton-seel8ZoK.js";import"./notifications-DM-9a7Is.js";import"./IconPlus-QsNVBJ5N.js";import"./IconQrcode-DcoHpd2K.js";import"./IconEdit-DwKL16RF.js";import"./IconTrash-KFql82qv.js";import"./IconInfoCircle-D5K91YCo.js";import"./IconExternalLink-CDh1KHXW.js";import"./StylishText-CD9I8-X7.js";import"./ModelType-C8nSW6qW.js";import"./IconSearch-CKaD9XHL.js";import"./ProgressBar-BhbAlmdB.js";function W(){return e.jsx(re,{size:18,color:"red"})}function Z({machine:i}){const o={marginLeft:"4px"};if(!i.active)return e.jsx(O,{sx:o,color:"gray",children:e.jsx(K,{})});let a="green";i.machine_errors.length>0||!i.is_driver_available||i.status>=300?a="red":i.status>=200&&(a="orange");const l=i.initialized&&i.status>0&&i.status<300;return e.jsx(O,{processing:l,sx:o,color:a,children:e.jsx(K,{})})}function E({includeTypes:i=!0,includeDrivers:o=!0}={}){const{data:a,isFetching:s,refetch:l}=z({enabled:i,queryKey:["machine-types"],queryFn:()=>B.get(M(F.machine_types_list)).then(p=>p.data),staleTime:1e4}),{data:t,isFetching:h,refetch:v}=z({enabled:o,queryKey:["machine-drivers"],queryFn:()=>B.get(M(F.machine_driver_list)).then(p=>p.data),staleTime:10*1e3}),y=f.useCallback(()=>{l(),v()},[v,l]);return{machineTypes:a,machineDrivers:t,isFetching:s||h,refresh:y}}function xe({machinePk:i,refreshTable:o}){const a=$(),{data:s,refetch:l,isFetching:t}=z({enabled:!0,queryKey:["machine-detail",i],queryFn:()=>B.get(M(F.machine_list,i)).then(d=>d.data)}),{machineTypes:h,machineDrivers:v,isFetching:y}=E(),p=t||y,m=f.useMemo(()=>h&&s?h.find(d=>d.slug===s.machine_type):void 0,[s==null?void 0:s.machine_type,h]),_=f.useMemo(()=>v&&s?v.find(d=>d.slug===s.driver):void 0,[s==null?void 0:s.driver,v]),C=f.useCallback(()=>{l(),o()},[l,o]),r=f.useCallback(d=>{B.post(M(F.machine_restart,void 0,{machine:d})).then(()=>{C(),X.show({message:n._({id:"8hvWaA"}),color:"green",icon:e.jsx(P,{size:"1rem"})})})},[C]);return e.jsxs(g,{spacing:"xs",children:[e.jsxs(u,{position:"apart",children:[e.jsx(K,{}),e.jsxs(u,{children:[s&&e.jsx(Z,{machine:s}),e.jsx(b,{order:4,children:s==null?void 0:s.name})]}),e.jsxs(u,{children:[(s==null?void 0:s.restart_required)&&e.jsx(L,{color:"red",children:e.jsx(x,{id:"dKwnjv"})}),e.jsx(se,{tooltip:n._({id:"72f9dQ"}),icon:e.jsx(le,{}),actions:[te({tooltip:n._({id:"RBquff"}),onClick:()=>{oe({title:n._({id:"RBquff"}),url:F.machine_list,pk:i,fields:{name:{},active:{}},onClose:()=>C()})}}),ie({tooltip:n._({id:"5ihjEH"}),onClick:()=>{de({title:n._({id:"5ihjEH"}),successMessage:n._({id:"ZbXCol"}),url:F.machine_list,pk:i,preFormContent:e.jsx(j,{children:n._({id:"Y9eJUJ",values:{0:s==null?void 0:s.name}})}),onFormSuccess:()=>{o(),a(-1)}})}}),{icon:e.jsx(A,{}),name:n._({id:"6z9W13"}),tooltip:n._({id:"Plnldt"})+(s!=null&&s.restart_required?" ("+n._({id:"kbLjlB"})+")":""),indicator:s!=null&&s.restart_required?{color:"red"}:void 0,onClick:()=>s&&r(s==null?void 0:s.pk)}]})]})]}),e.jsx(k,{withBorder:!0,children:e.jsxs(g,{spacing:"md",children:[e.jsxs(u,{position:"apart",children:[e.jsx(b,{order:4,children:e.jsx(x,{id:"TXZA6i"})}),e.jsx(T,{variant:"outline",onClick:()=>l(),children:e.jsx(A,{})})]}),e.jsxs(g,{pos:"relative",spacing:"xs",children:[e.jsx(Y,{visible:p,overlayOpacity:0}),e.jsx(c,{name:n._({id:"pwL+bm"}),children:e.jsxs(u,{spacing:"xs",children:[m?e.jsx(U,{to:`../type-${s==null?void 0:s.machine_type}`,text:m.name}):e.jsx(j,{children:s==null?void 0:s.machine_type}),s&&!m&&e.jsx(W,{})]})}),e.jsx(c,{name:n._({id:"3ADt1I"}),children:e.jsxs(u,{spacing:"xs",children:[_?e.jsx(U,{to:`../driver-${s==null?void 0:s.driver}`,text:_.name}):e.jsx(j,{children:s==null?void 0:s.driver}),!(s!=null&&s.is_driver_available)&&e.jsx(W,{})]})}),e.jsx(c,{name:n._({id:"nsu9Un"}),children:e.jsx(Q,{value:(s==null?void 0:s.initialized)||!1})}),e.jsx(c,{name:n._({id:"F6pfE9"}),children:e.jsx(Q,{value:(s==null?void 0:s.active)||!1})}),e.jsx(c,{name:n._({id:"uAQUqI"}),children:e.jsxs(D,{direction:"column",children:[(s==null?void 0:s.status)===-1?e.jsx(j,{fz:"xs",children:"No status"}):ae({status:`${(s==null?void 0:s.status)||-1}`,type:`MachineStatus__${s==null?void 0:s.status_model}`}),e.jsx(j,{fz:"sm",children:s==null?void 0:s.status_text})]})}),e.jsxs(u,{position:"apart",spacing:"xs",children:[e.jsxs(j,{fz:"sm",fw:700,children:[e.jsx(x,{id:"UirGxE"}),":"]}),s&&(s==null?void 0:s.machine_errors.length)>0?e.jsx(L,{color:"red",sx:{marginLeft:"10px"},children:s==null?void 0:s.machine_errors.length}):e.jsx(j,{fz:"xs",children:e.jsx(x,{id:"hIOaIF"})}),e.jsx(I,{w:"100%",children:s==null?void 0:s.machine_errors.map((d,w)=>e.jsx(I.Item,{children:e.jsx(G,{children:d})},w))})]})]})]})}),e.jsx(S,{h:"10px"}),(s==null?void 0:s.is_driver_available)&&e.jsxs(e.Fragment,{children:[e.jsxs(k,{withBorder:!0,children:[e.jsx(b,{order:5,pb:4,children:e.jsx(x,{id:"m57e2B"})}),e.jsx(J,{machinePk:i,configType:"M",onChange:C})]}),e.jsxs(k,{withBorder:!0,children:[e.jsx(b,{order:5,pb:4,children:e.jsx(x,{id:"fWJCep"})}),e.jsx(J,{machinePk:i,configType:"D",onChange:C})]})]})]})}function H({props:i,renderMachineDrawer:o=!0,createProps:a}){const{machineTypes:s,machineDrivers:l}=E(),t=R("machine"),h=$(),v=f.useMemo(()=>[{accessor:"name",sortable:!0,render:function(r){return e.jsxs(u,{position:"left",noWrap:!0,children:[e.jsx(Z,{machine:r}),e.jsx(j,{children:r.name}),r.restart_required&&e.jsx(L,{color:"red",children:e.jsx(x,{id:"dKwnjv"})})]})}},{accessor:"machine_type",sortable:!0,render:r=>{const d=s==null?void 0:s.find(w=>w.slug===r.machine_type);return e.jsxs(u,{spacing:"xs",children:[e.jsx(j,{children:d?d.name:r.machine_type}),s&&!d&&e.jsx(W,{})]})}},{accessor:"driver",sortable:!0,render:r=>{const d=l==null?void 0:l.find(w=>w.slug===r.driver);return e.jsxs(u,{spacing:"xs",children:[e.jsx(j,{children:d?d.name:r.driver}),!r.is_driver_available&&e.jsx(W,{})]})}},q({accessor:"initialized"}),q({accessor:"active"}),{accessor:"status",sortable:!1,render:r=>{const d=ne(`MachineStatus__${r.status_model}`);if(d&&r.status!==-1)return d(r)}}],[s]),[y,p]=f.useState(null),m=f.useMemo(()=>l?l.filter(r=>r.machine_type===y).map(r=>({value:r.slug,display_name:r.name})):[],[l,y]),_=ce({title:n._({id:"2Whws6"}),url:F.machine_list,fields:{name:{},machine_type:{hidden:!!(a!=null&&a.machine_type),...a!=null&&a.machine_type?{value:a.machine_type}:{},field_type:"choice",choices:s?s.map(r=>({value:r.slug,display_name:r.name})):[],onValueChange:r=>p(r)},driver:{hidden:!!(a!=null&&a.driver),...a!=null&&a.driver?{value:a.driver}:{},field_type:"choice",disabled:!y,choices:m},active:{}},onFormSuccess:r=>{t.refreshTable(),h(o?`machine-${r.pk}/`:`../machine-${r.pk}/`)},onClose:()=>{p(null)}}),C=f.useMemo(()=>[e.jsx(ee,{variant:"outline",onClick:()=>{p(null),_.open()}})],[_.open]);return e.jsxs(e.Fragment,{children:[_.modal,o&&e.jsx(N,{title:n._({id:"dGaozN"}),size:"lg",renderContent:r=>!r||!r.startsWith("machine-")?!1:e.jsx(xe,{machinePk:r.replace("machine-",""),refreshTable:t.refreshTable})}),e.jsx(V,{url:M(F.machine_list),tableState:t,columns:v,props:{...i,enableDownload:!1,onRowClick:r=>h(o?`machine-${r.pk}/`:`../machine-${r.pk}/`),tableActions:C,params:{...i.params},tableFilters:[{name:"active",type:"boolean"},{name:"machine_type",type:"choice",choiceFunction:()=>s?s.map(r=>({value:r.slug,label:r.name})):[]},{name:"driver",type:"choice",choiceFunction:()=>l?l.map(r=>({value:r.slug,label:r.name})):[]}]}})]})}function ue({machineTypeSlug:i}){var y,p,m;const o=$(),{machineTypes:a,refresh:s,isFetching:l}=E({includeDrivers:!1}),t=f.useMemo(()=>a==null?void 0:a.find(_=>_.slug===i),[a,i]),h=R("machineDrivers"),v=f.useMemo(()=>[{accessor:"name",title:n._({id:"6YtxFj"})},{accessor:"description",title:n._({id:"Nu4oKW"})},q({accessor:"is_builtin",title:n._({id:"argeGI"})})],[]);return e.jsxs(g,{children:[e.jsx(u,{position:"center",children:e.jsx(b,{order:4,children:t?t.name:i})}),!t&&e.jsx(j,{italic:!0,children:e.jsx(x,{id:"FW2Ygg"})}),e.jsx(k,{withBorder:!0,children:e.jsxs(g,{spacing:"md",children:[e.jsxs(u,{position:"apart",children:[e.jsx(b,{order:4,children:e.jsx(x,{id:"IBrg3Y"})}),e.jsx(T,{variant:"outline",onClick:()=>s(),children:e.jsx(A,{})})]}),e.jsxs(g,{pos:"relative",spacing:"xs",children:[e.jsx(Y,{visible:l,overlayOpacity:0}),e.jsx(c,{name:n._({id:"6YtxFj"}),value:t==null?void 0:t.name,type:"text"}),e.jsx(c,{name:n._({id:"L85WcV"}),value:t==null?void 0:t.slug,type:"text"}),e.jsx(c,{name:n._({id:"Nu4oKW"}),value:t==null?void 0:t.description,type:"text"}),!(t!=null&&t.is_builtin)&&e.jsx(c,{name:n._({id:"umAemZ"}),value:(y=t==null?void 0:t.provider_plugin)==null?void 0:y.name,type:"text",link:((p=t==null?void 0:t.provider_plugin)==null?void 0:p.pk)!==null?`../../plugin/${(m=t==null?void 0:t.provider_plugin)==null?void 0:m.pk}/`:void 0,detailDrawerLink:!0}),e.jsx(c,{name:n._({id:"jfVQG5"}),value:t==null?void 0:t.provider_file,type:"code"}),e.jsx(c,{name:n._({id:"++LBSt"}),value:t==null?void 0:t.is_builtin,type:"boolean"})]})]})}),e.jsx(k,{withBorder:!0,children:e.jsxs(g,{spacing:"md",children:[e.jsx(b,{order:4,children:e.jsx(x,{id:"7wk8VI"})}),e.jsx(V,{url:M(F.machine_driver_list),tableState:h,columns:v,props:{dataFormatter:_=>_.filter(C=>C.machine_type===i),enableDownload:!1,enableSearch:!1,onRowClick:_=>o(`../driver-${_.slug}/`)}})]})})]})}function pe({machineDriverSlug:i}){var v,y,p;const{machineDrivers:o,machineTypes:a,refresh:s,isFetching:l}=E(),t=f.useMemo(()=>o==null?void 0:o.find(m=>m.slug===i),[o,i]),h=f.useMemo(()=>a==null?void 0:a.find(m=>m.slug===(t==null?void 0:t.machine_type)),[o,a]);return e.jsxs(g,{children:[e.jsx(u,{position:"center",children:e.jsx(b,{order:4,children:t?t.name:i})}),!t&&e.jsx(j,{italic:!0,children:e.jsx(x,{id:"p6inm0"})}),e.jsx(k,{withBorder:!0,children:e.jsxs(g,{spacing:"md",children:[e.jsxs(u,{position:"apart",children:[e.jsx(b,{order:4,children:e.jsx(x,{id:"Dm7Jy5"})}),e.jsx(T,{variant:"outline",onClick:()=>s(),children:e.jsx(A,{})})]}),e.jsxs(g,{pos:"relative",spacing:"xs",children:[e.jsx(Y,{visible:l,overlayOpacity:0}),e.jsx(c,{name:n._({id:"6YtxFj"}),value:t==null?void 0:t.name,type:"text"}),e.jsx(c,{name:n._({id:"L85WcV"}),value:t==null?void 0:t.slug,type:"text"}),e.jsx(c,{name:n._({id:"Nu4oKW"}),value:t==null?void 0:t.description,type:"text"}),e.jsx(c,{name:n._({id:"I+nMNp"}),value:h?h.name:t==null?void 0:t.machine_type,type:"text",link:h?`../type-${t==null?void 0:t.machine_type}`:void 0,detailDrawerLink:!0}),!(t!=null&&t.is_builtin)&&e.jsx(c,{name:n._({id:"umAemZ"}),value:(v=t==null?void 0:t.provider_plugin)==null?void 0:v.name,type:"text",link:((y=t==null?void 0:t.provider_plugin)==null?void 0:y.pk)!==null?`../../plugin/${(p=t==null?void 0:t.provider_plugin)==null?void 0:p.pk}/`:void 0,detailDrawerLink:!0}),e.jsx(c,{name:n._({id:"jfVQG5"}),value:t==null?void 0:t.provider_file,type:"code"}),e.jsx(c,{name:n._({id:"++LBSt"}),value:t==null?void 0:t.is_builtin,type:"boolean"}),e.jsxs(u,{position:"apart",spacing:"xs",children:[e.jsxs(j,{fz:"sm",fw:700,children:[e.jsx(x,{id:"UirGxE"}),":"]}),t&&(t==null?void 0:t.driver_errors.length)>0?e.jsx(L,{color:"red",sx:{marginLeft:"10px"},children:t.driver_errors.length}):e.jsx(j,{fz:"xs",children:e.jsx(x,{id:"hIOaIF"})}),e.jsx(I,{w:"100%",children:t==null?void 0:t.driver_errors.map((m,_)=>e.jsx(I.Item,{children:e.jsx(G,{children:m})},_))})]})]})]})}),e.jsx(k,{withBorder:!0,children:e.jsxs(g,{spacing:"md",children:[e.jsx(b,{order:4,children:e.jsx(x,{id:"Qf5DYN"})}),e.jsx(H,{props:{params:{driver:i}},renderMachineDrawer:!1,createProps:{machine_type:t==null?void 0:t.machine_type,driver:i}})]})})]})}function je({props:i}){const o=R("machineTypes"),a=$(),s=f.useMemo(()=>[{accessor:"name",title:n._({id:"6YtxFj"})},{accessor:"description",title:n._({id:"Nu4oKW"})},q({accessor:"is_builtin",title:n._({id:"eBtH/D"})})],[]);return e.jsxs(e.Fragment,{children:[e.jsx(N,{title:n._({id:"9Lc7+e"}),size:"lg",renderContent:l=>!l||!l.startsWith("type-")?!1:e.jsx(ue,{machineTypeSlug:l.replace("type-","")})}),e.jsx(N,{title:n._({id:"VDbgpF"}),size:"lg",renderContent:l=>!l||!l.startsWith("driver-")?!1:e.jsx(pe,{machineDriverSlug:l.replace("driver-","")})}),e.jsx(V,{url:M(F.machine_types_list),tableState:o,columns:s,props:{...i,enableDownload:!1,enableSearch:!1,onRowClick:l=>a(`type-${l.slug}/`),params:{...i.params}}})]})}function Ve(){var a;const{data:i,refetch:o}=z({queryKey:["machine-registry-status"],queryFn:()=>B.get(M(F.machine_registry_status)).then(s=>s.data),staleTime:1e4});return e.jsxs(g,{children:[e.jsx(H,{props:{}}),e.jsx(S,{h:"10px"}),e.jsxs(g,{spacing:"xs",children:[e.jsx(b,{order:5,children:e.jsx(x,{id:"LuGy8Q"})}),e.jsx(je,{props:{}})]}),e.jsx(S,{h:"10px"}),e.jsxs(g,{spacing:"xs",children:[e.jsxs(u,{children:[e.jsx(b,{order:5,children:e.jsx(x,{id:"1ctV9a"})}),e.jsx(T,{variant:"outline",onClick:()=>o(),children:e.jsx(A,{})})]}),i!=null&&i.registry_errors&&i.registry_errors.length===0?e.jsx(j,{italic:!0,children:e.jsx(x,{id:"LK9cs2"})}):e.jsx(I,{children:(a=i==null?void 0:i.registry_errors)==null?void 0:a.map((s,l)=>e.jsx(I.Item,{children:e.jsx(G,{children:s.message})},l))})]})]})}export{Ve as default};
