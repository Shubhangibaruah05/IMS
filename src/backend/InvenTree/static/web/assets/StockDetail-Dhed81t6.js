import{r as n,j as s,b7 as Se,i as t,G as F,m as V,b5 as Z,b9 as ee,z as re,bl as te,I as Ie,ak as we,ba as C,bK as z,cY as Y,ex as Te,ey as Ae,bf as g,ez as Ce,eA as ve,aW as Pe,ac as De,ad as Me,H as Re,aL as qe,S as Be}from"./vendor-B0vSnHFf.js";import{A as Ee}from"./AdminButton-Cl1ixKQi.js";import{u as G,I as L,R as Fe,a as ze,e as Ke,Y as Ne,B as Ue,P as Ye,A as se,d as Ve,E as Ge,D as Le}from"./InvenTreeTable-D26a1r6-.js";import{I as Oe,D as K,a as We}from"./InstanceDetail-Cejekc8J.js";import{D as v}from"./DetailsBadge-oD3BwL5r.js";import{D as Je,N as He}from"./NotesEditor-DCyldUZp.js";import{S as ae}from"./StylishText-CrpvZzAV.js";import{N as Qe}from"./NavigationTree-Cw872Gub.js";import{P as Xe}from"./PageDetail-B4PsctWo.js";import{P as $e}from"./PanelGroup-DRVQKYn0.js";import{h as de,k as Ze,S as ce,f as et,l as tt,m as st,o as at,p as lt,q as it,r as ot,g as le}from"./Instance-Co8OMzcE.js";import{a as O,M as o,e as P,A as m,d as ie,U as x}from"./index-CDdQlqFV.js";import{j as nt,a as oe,e as rt,c as dt,d as ct,b as ut}from"./StockForms-DLBgZVBa.js";import{I as N}from"./BaseContext-DSwOqL9e.js";import{a as ue,u as me,b as pe}from"./UseForm-BimrM1zK.js";import{u as mt}from"./UseInstance-Bcp_oSAZ.js";import{B as pt}from"./BuildAllocatedStockTable-BtxDATbE.js";import{A as _t}from"./AttachmentTable-Mxcn-H07.js";import{S as bt}from"./SalesOrderAllocationTable-kY828FjS.js";import{a as ht,S as kt,D as _e,N as xt,j as be,m as ne}from"./ColumnRenderers-CwItNORh.js";import{S as ft}from"./StockItemTable-Cop_NVCl.js";import{A as jt}from"./AddItemButton-CD0U_4gd.js";import{P as yt}from"./YesNoButton-1B57tnbm.js";import{A as gt}from"./AttachmentLink-CL1ofkZf.js";import{u as he,d as St}from"./DesktopAppView-CofLSp00.js";import"./ActionButton-Br0cBRLA.js";import"./Boundary-CysPC9mI.js";import"./GenericErrorPage-BifXQa91.js";import"./NotFound-DXIcBWRy.js";import"./PermissionDenied-Cl_T9Vqt.js";import"./UseGenerator-C7bjPlPb.js";function It({parentId:p}){const l=G("stock_item_install"),_=O(),b=n.useMemo(()=>[{accessor:"part",switchable:!1,render:e=>ht(e==null?void 0:e.part_detail)},{accessor:"quantity",switchable:!1,render:e=>{let i=e.quantity;return e.serial&&e.quantity==1&&(i=`# ${e.serial}`),i}},{accessor:"batch",switchable:!1},kt({model:o.stockitem})],[]),h=n.useMemo(()=>[],[_]);return s.jsx(L,{url:P(m.stock_item_list),tableState:l,columns:b,props:{tableActions:h,modelType:o.stockitem,params:{belongs_to:p,part_detail:!0}}})}function wt({partId:p,itemId:l}){const _=O(),b=G("stocktests"),{data:h}=Se({queryKey:["stocktesttemplates",p,l],queryFn:async()=>p?ie.get(P(m.part_test_template_list),{params:{part:p,include_inherited:!0,enabled:!0}}).then(a=>a.data).catch(a=>[]):[]});n.useEffect(()=>{b.refreshTable()},[h]);const e=n.useCallback(a=>{let r=h.map(d=>({...d,templateId:d.pk,results:[]}));return a.forEach(d=>{r.find(u=>u.templateId==d.template)||r.push({...d.template_detail,templateId:d.template,results:[]})}),a.sort((d,u)=>d.pk>u.pk?1:-1).forEach(d=>{let u=r.findIndex(y=>y.templateId==d.template);u>=0&&(r[u]={...r[u],...d},r[u].results.push(d))}),r},[p,l,h]),i=n.useMemo(()=>[{accessor:"test",title:t._({id:"NnH3pK"}),switchable:!1,sortable:!0,render:a=>{var u,y;const r=a.enabled??((u=a.template_detail)==null?void 0:u.enabled),d=a.stock_item!=null&&a.stock_item!=l;return s.jsxs(F,{justify:"space-between",wrap:"nowrap",children:[s.jsxs(V,{style:{fontStyle:d?"italic":void 0},c:r?void 0:"red",children:[!a.templateId&&"- ",a.test_name??((y=a.template_detail)==null?void 0:y.test_name)]}),s.jsxs(F,{justify:"right",children:[a.results&&a.results.length>1&&s.jsx(Z,{label:t._({id:"isbwWo"}),children:s.jsx(ee,{color:"lightblue",variant:"filled",children:a.results.length})}),d&&s.jsx(Z,{label:t._({id:"yd1WJ/"}),children:s.jsx(re,{size:16,color:"blue"})})]})]})}},{accessor:"result",title:t._({id:"RD6AE9"}),switchable:!1,sortable:!0,render:a=>a.result===void 0?s.jsx(ee,{color:"lightblue",variant:"filled",children:t._({id:"4bobEy"})}):s.jsx(yt,{value:a.result})},_e({accessor:"description"}),{accessor:"value",title:t._({id:"wMHvYH"})},{accessor:"attachment",title:t._({id:"UY1vmE"}),render:a=>a.attachment&&s.jsx(gt,{attachment:a.attachment})},xt({}),be({}),{accessor:"user",title:t._({id:"7PzzBU"}),sortable:!1,render:a=>a.user_detail&&s.jsx(de,{instance:a.user_detail})},{accessor:"test_station",sortable:!0,title:t._({id:"18Lf3c"})},{accessor:"started_datetime",sortable:!0,title:t._({id:"JEGlfK"}),render:a=>s.jsx(F,{justify:"space-between",children:ne(a.started_datetime,{showTime:!0,showSeconds:!0})})},{accessor:"finished_datetime",sortable:!0,title:t._({id:"4dQFvz"}),render:a=>s.jsx(F,{justify:"space-between",children:ne(a.finished_datetime,{showTime:!0,showSeconds:!0})})}],[l]),[k,f]=n.useState(void 0),S=nt({partId:p,itemId:l,templateId:k}),I=ue({url:m.stock_test_result_list,fields:n.useMemo(()=>({...S}),[S]),initialData:{template:k,result:!0},title:t._({id:"VzkBcq"}),table:b,successMessage:t._({id:"VivtT0"})}),[T,D]=n.useState(0),M=me({url:m.stock_test_result_list,pk:T,fields:n.useMemo(()=>({...S}),[S]),title:t._({id:"1HKt5e"}),table:b,successMessage:t._({id:"G0v/SO"})}),R=pe({url:m.stock_test_result_list,pk:T,title:t._({id:"381PhV"}),table:b,successMessage:t._({id:"xbuMqN"})}),A=n.useCallback(a=>{ie.post(P(m.stock_test_result_list),{template:a,stock_item:l,result:!0}).then(()=>{b.refreshTable(),te({title:t._({id:"uUlW4e"}),message:t._({id:"uiR3yF"}),color:"green"})}).catch(()=>{te({title:t._({id:"SlfejT"}),message:t._({id:"VjER3N"}),color:"red"})})},[l]),q=n.useCallback(a=>a.stock_item!=null&&a.stock_item!=l?[]:[{title:t._({id:"up/ozE"}),color:"green",icon:s.jsx(Ie,{}),hidden:!a.templateId||(a==null?void 0:a.requires_attachment)||(a==null?void 0:a.requires_value)||a.result,onClick:()=>A(a.templateId)},{title:t._({id:"m16xKo"}),tooltip:t._({id:"VzkBcq"}),color:"green",icon:s.jsx(we,{}),hidden:!_.hasAddRole(x.stock)||!a.templateId,onClick:()=>{f(a.templateId),I.open()}},Fe({tooltip:t._({id:"1HKt5e"}),hidden:!_.hasChangeRole(x.stock)||!a.template_detail,onClick:()=>{D(a.pk),M.open()}}),ze({tooltip:t._({id:"381PhV"}),hidden:!_.hasDeleteRole(x.stock)||!a.template_detail,onClick:()=>{D(a.pk),R.open()}})],[_,l]),B=n.useMemo(()=>[{name:"required",label:t._({id:"TMLAx2"}),description:t._({id:"sKK8za"})},{name:"include_installed",label:t._({id:"TD72EF"}),description:t._({id:"BYeSw1"})},{name:"result",label:t._({id:"nqMwPi"}),description:t._({id:"bcwRe2"})}],[]),U=n.useMemo(()=>[s.jsx(jt,{tooltip:t._({id:"VzkBcq"}),onClick:()=>{f(void 0),I.open()},hidden:!_.hasAddRole(x.stock)})],[_]),E=n.useMemo(()=>{const a=[...i,{accessor:"actions",title:"  ",hidden:!1,switchable:!1,width:50,render:r=>s.jsx(Ke,{actions:q(r)??[]})}];return{allowMultiple:!0,content:({record:r})=>{if(!r||!r.results||r.results.length<2)return null;const d=(r==null?void 0:r.results)??[];return s.jsx(Ne,{noHeader:!0,columns:a,records:d.slice(0,-1)},r.pk)}}},[]);return s.jsxs(s.Fragment,{children:[I.modal,M.modal,R.modal,s.jsx(L,{url:P(m.stock_test_result_list),tableState:b,columns:i,props:{dataFormatter:e,enablePagination:!1,tableActions:U,tableFilters:B,rowActions:q,rowExpansion:E,params:{stock_item:l,user_detail:!0,attachment_detail:!0,template_detail:!0,enabled:!0}}})]})}function Tt({itemId:p}){const l=he(),_=G("stock_tracking"),b=n.useCallback(e=>{const i=(e==null?void 0:e.deltas)??{};let k=[{label:t._({id:"igx8Og"}),key:"stockitem",details:i.stockitem_detail&&Ze({instance:i.stockitem_detail})},{label:t._({id:"uAQUqI"}),key:"status",details:i.status&&ce({status:i.status,type:o.stockitem})},{label:t._({id:"VbWX2u"}),key:"quantity",details:i.quantity},{label:t._({id:"hp8OtS"}),key:"added",details:i.added},{label:t._({id:"eps54V"}),key:"removed",details:i.removed},{label:t._({id:"vgP+9p"}),key:"part",details:i.part_detail&&et({instance:i.part_detail,link:!0,navigate:l})},{label:t._({id:"wJijgU"}),key:"location",details:i.location_detail&&tt({instance:i.location_detail,link:!0,navigate:l})},{label:t._({id:"YxwWvi"}),key:"buildorder",details:i.buildorder_detail&&st({instance:i.buildorder_detail,link:!0,navigate:l})},{label:t._({id:"KxySMG"}),key:"purchaseorder",details:i.purchaseorder_detail&&at({instance:i.purchaseorder_detail,link:!0,navigate:l})},{label:t._({id:"LozYBo"}),key:"salesorder",details:i.salesorder_detail&&lt({instance:i.salesorder_detail,link:!0,navigate:l})},{label:t._({id:"Z6ve1w"}),key:"returnorder",details:i.returnorder_detail&&it({instance:i.returnorder_detail,link:!0,navigate:l})},{label:t._({id:"876pfE"}),key:"customer",details:i.customer_detail&&ot({instance:i.customer_detail,link:!0,navigate:l})}];return s.jsx(C,{striped:!0,children:s.jsx(C.Tbody,{children:k.map(f=>f.details&&s.jsxs(C.Tr,{children:[s.jsx(C.Td,{children:s.jsx(V,{children:f.label})}),s.jsx(C.Td,{children:f.details})]},f.key))})})},[l]),h=n.useMemo(()=>[be({switchable:!1}),_e({accessor:"label"}),{accessor:"details",title:t._({id:"URmyfc"}),switchable:!1,render:b},{accessor:"notes",title:t._({id:"1DBGsz"}),sortable:!1,switchable:!0},{accessor:"user",title:t._({id:"7PzzBU"}),render:e=>e.user_detail?de({instance:e.user_detail}):s.jsx(V,{size:"sm",fs:"italic",children:t._({id:"L5d7xh"})})}],[]);return s.jsx(L,{tableState:_,url:P(m.stock_tracking_list),columns:h,props:{params:{item:p,user_detail:!0},enableDownload:!0}})}function ls(){var W,J;const{id:p}=St(),l=O(),_=he(),[b,h]=n.useState(!1),{instance:e,refreshInstance:i,instanceQuery:k,requestStatus:f}=mt({endpoint:m.stock_item_list,pk:p,params:{part_detail:!0,location_detail:!0,path_detail:!0}}),S=n.useMemo(()=>{var H,Q;let c=e,w=(e==null?void 0:e.part_detail)??{};if(c.available_stock=Math.max(0,c.quantity-c.allocated),k.isFetching)return s.jsx(z,{});let fe=[{name:"part",label:t._({id:"mY+KgP"}),type:"link",model:o.part},{name:"status",type:"status",label:t._({id:"Y3/0dR"}),model:o.stockitem},{type:"text",name:"tests",label:"Completed Tests",icon:"progress",hidden:!(w!=null&&w.testable)},{type:"text",name:"updated",icon:"calendar",label:t._({id:"K7P0jz"})},{type:"text",name:"stocktake",icon:"calendar",label:t._({id:"whZ7zT"}),hidden:!e.stocktake}],je=[{type:"text",name:"quantity",label:t._({id:"VbWX2u"})},{type:"text",name:"serial",label:t._({id:"AXeJt4"}),hidden:!e.serial},{type:"text",name:"available_stock",label:t._({id:"csDS2L"}),icon:"quantity"},{type:"text",name:"batch",label:t._({id:"Vea6Aj"}),hidden:!e.batch}],ye=[{name:"supplier_part",label:t._({id:"nne72x"}),type:"link",model:o.supplierpart,hidden:!e.supplier_part},{type:"link",name:"location",label:t._({id:"wJijgU"}),model:o.stocklocation,hidden:!e.location},{type:"link",name:"belongs_to",label:t._({id:"QPoAhl"}),model_formatter:j=>{var $;let X=(($=j==null?void 0:j.part_detail)==null?void 0:$.full_name)??(j==null?void 0:j.name);return j.serial&&j.quantity==1&&(X+=`# ${j.serial}`),X},icon:"stock",model:o.stockitem,hidden:!e.belongs_to},{type:"link",name:"consumed_by",label:t._({id:"H00rnl"}),model:o.build,hidden:!e.consumed_by,icon:"build",model_field:"reference"},{type:"link",name:"build",label:t._({id:"YxwWvi"}),model:o.build,hidden:!e.build,model_field:"reference"},{type:"link",name:"sales_order",label:t._({id:"LozYBo"}),model:o.salesorder,hidden:!e.sales_order,icon:"sales_orders",model_field:"reference"},{type:"link",name:"customer",label:t._({id:"876pfE"}),model:o.company,hidden:!e.customer}],ge=[{type:"text",name:"packaging",icon:"part",label:t._({id:"pD/Ew0"}),hidden:!e.packaging}];return s.jsxs(Oe,{children:[s.jsxs(Y,{children:[s.jsx(Y.Col,{span:4,children:s.jsx(Je,{appRole:x.part,apiPath:m.part_list,src:((H=e.part_detail)==null?void 0:H.image)??((Q=e==null?void 0:e.part_detail)==null?void 0:Q.thumbnail),pk:e.part})}),s.jsx(Y.Col,{span:8,children:s.jsx(K,{fields:fe,item:e})})]}),s.jsx(K,{fields:je,item:e}),s.jsx(K,{fields:ye,item:e}),s.jsx(K,{fields:ge,item:e})]})},[e,k]),I=n.useMemo(()=>{var c;return((c=e==null?void 0:e.part_detail)==null?void 0:c.component)&&!(e!=null&&e.sales_order)&&!(e!=null&&e.belongs_to)},[e]),T=n.useMemo(()=>{var c;return(c=e==null?void 0:e.part_detail)==null?void 0:c.salable},[e]),D=n.useMemo(()=>{var c,w;return[{name:"details",label:t._({id:"hBG+yp"}),icon:s.jsx(re,{}),content:S},{name:"tracking",label:t._({id:"IdrYoA"}),icon:s.jsx(Te,{}),content:e.pk?s.jsx(Tt,{itemId:e.pk}):s.jsx(z,{})},{name:"allocations",label:t._({id:"KwhnxF"}),icon:s.jsx(Ae,{}),hidden:!T&&!I,content:s.jsxs(g,{multiple:!0,defaultValue:["buildallocations","salesallocations"],children:[I&&s.jsxs(g.Item,{value:"buildallocations",children:[s.jsx(g.Control,{children:s.jsx(ae,{size:"lg",children:t._({id:"KCpl4N"})})}),s.jsx(g.Panel,{children:s.jsx(pt,{stockId:e.pk,modelField:"build",modelTarget:o.build,showBuildInfo:!0})})]},"buildallocations"),T&&s.jsxs(g.Item,{value:"salesallocations",children:[s.jsx(g.Control,{children:s.jsx(ae,{size:"lg",children:t._({id:"DaWMWw"})})}),s.jsx(g.Panel,{children:s.jsx(bt,{stockId:e.pk,modelField:"order",modelTarget:o.salesorder,showOrderInfo:!0})})]},"salesallocations")]})},{name:"testdata",label:t._({id:"dljGeD"}),icon:s.jsx(Ce,{}),hidden:!((c=e==null?void 0:e.part_detail)!=null&&c.testable),content:e!=null&&e.pk?s.jsx(wt,{itemId:e.pk,partId:e.part}):s.jsx(z,{})},{name:"installed_items",label:t._({id:"xnskHi"}),icon:s.jsx(ve,{}),hidden:!((w=e==null?void 0:e.part_detail)!=null&&w.assembly),content:s.jsx(It,{parentId:e.pk})},{name:"child_items",label:t._({id:"K4v96J"}),icon:s.jsx(Pe,{}),hidden:((e==null?void 0:e.child_items)??0)==0,content:e!=null&&e.pk?s.jsx(ft,{tableName:"child-stock",params:{ancestor:e.pk}}):s.jsx(z,{})},{name:"attachments",label:t._({id:"w/Sphq"}),icon:s.jsx(De,{}),content:s.jsx(_t,{model_type:o.stockitem,model_id:e.pk})},{name:"notes",label:t._({id:"1DBGsz"}),icon:s.jsx(Me,{}),content:s.jsx(He,{modelType:o.stockitem,modelId:e.pk,editable:l.hasChangeRole(x.stock)})}]},[e,p,l]),M=n.useMemo(()=>[{name:t._({id:"blbbPS"}),url:"/stock"},...(e.location_path??[]).map(c=>({name:c.name,url:le(o.stocklocation,c.pk)}))],[e]),R=oe({create:!1}),A=me({url:m.stock_item_list,pk:e.pk,title:t._({id:"gQgYNs"}),fields:R,onFormSuccess:i}),q=oe({create:!0}),B=ue({url:m.stock_item_list,title:t._({id:"bJLEQT"}),fields:q,initialData:{...e},follow:!0,modelType:o.stockitem}),U=n.useMemo(()=>{},[e]),E=pe({url:m.stock_item_list,pk:e.pk,title:t._({id:"BJoa27"}),preFormContent:U,onFormSuccess:()=>{_(le(o.part,e.part))}}),a=n.useMemo(()=>({items:e,model:o.stockitem,refresh:i,filters:{in_stock:!0}}),[e]),r=rt(a),d=dt(a),u=ct(a),y=ut(a),ke=n.useMemo(()=>[s.jsx(Ee,{model:o.stockitem,pk:e.pk}),s.jsx(Ue,{model:o.stockitem,pk:e.pk,hash:e==null?void 0:e.barcode_hash,perm:l.hasChangeRole(x.stock)}),s.jsx(Ye,{modelType:o.stockitem,items:[e.pk],enableReports:!0,enableLabels:!0}),s.jsx(se,{tooltip:t._({id:"ClJC3x"}),icon:s.jsx(Re,{}),actions:[{name:t._({id:"wBMjJ2"}),tooltip:t._({id:"rb0Klh"}),icon:s.jsx(N,{icon:"stocktake",iconProps:{color:"blue"}}),onClick:()=>{e.pk&&r.open()}},{name:t._({id:"m16xKo"}),tooltip:t._({id:"vq/m8u"}),icon:s.jsx(N,{icon:"add",iconProps:{color:"green"}}),onClick:()=>{e.pk&&d.open()}},{name:t._({id:"t/YqKh"}),tooltip:t._({id:"qpe+W0"}),icon:s.jsx(N,{icon:"remove",iconProps:{color:"red"}}),onClick:()=>{e.pk&&u.open()}},{name:t._({id:"zPGNJm"}),tooltip:t._({id:"+OxnAC"}),icon:s.jsx(N,{icon:"transfer",iconProps:{color:"blue"}}),onClick:()=>{e.pk&&y.open()}}]}),s.jsx(se,{tooltip:t._({id:"oPF3fX"}),icon:s.jsx(qe,{}),actions:[Ve({hidden:!l.hasAddRole(x.stock),onClick:()=>B.open()}),Ge({hidden:!l.hasChangeRole(x.stock),onClick:()=>A.open()}),Le({hidden:!l.hasDeleteRole(x.stock),onClick:()=>E.open()})]})],[p,e,l]),xe=n.useMemo(()=>{let c=((e==null?void 0:e.quantity)??0)-((e==null?void 0:e.allocated)??0);return c=Math.max(0,c),k.isLoading?[]:[s.jsx(v,{color:"yellow",label:t._({id:"BE5Q6v"}),visible:e.is_building}),s.jsx(v,{color:"blue",label:t._({id:"AXeJt4"})+`: ${e.serial}`,visible:!!e.serial},"serial"),s.jsx(v,{color:"blue",label:t._({id:"VbWX2u"})+`: ${e.quantity}`,visible:!e.serial},"quantity"),s.jsx(v,{color:"yellow",label:t._({id:"csDS2L"})+`: ${c}`,visible:!e.serial&&c!=e.quantity},"available"),s.jsx(v,{color:"blue",label:t._({id:"Vea6Aj"})+`: ${e.batch}`,visible:!!e.batch},"batch"),s.jsx(ce,{status:e.status_custom_key,type:o.stockitem,options:{size:"lg"}},"status")]},[e,k]);return s.jsx(We,{status:f,loading:k.isFetching,children:s.jsxs(Be,{children:[s.jsx(Qe,{title:t._({id:"1eBWAw"}),modelType:o.stocklocation,endpoint:m.stock_location_tree,opened:b,onClose:()=>h(!1),selectedId:e==null?void 0:e.location}),s.jsx(Xe,{title:t._({id:"igx8Og"}),subtitle:(W=e.part_detail)==null?void 0:W.full_name,imageUrl:(J=e.part_detail)==null?void 0:J.thumbnail,editAction:A.open,editEnabled:l.hasChangePermission(o.stockitem),badges:xe,breadcrumbs:M,breadcrumbAction:()=>{h(!0)},actions:ke}),s.jsx($e,{pageKey:"stockitem",panels:D}),A.modal,B.modal,E.modal,r.modal,d.modal,u.modal,y.modal]})})}export{ls as default};
