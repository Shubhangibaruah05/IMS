import{j as e,z as se,G as p,T as ie,eE as ae,bk as le,bi as X,r as f,i as o,q as Y,eF as oe,eG as re,bb as q,cY as Q,S as B,cm as Z,m as I,b6 as k,ai as L,b$ as ce,aD as ue,b3 as de,c3 as he,eH as xe,c2 as J,bm as fe,ba as je,bC as pe,b_ as me,eI as ge,e6 as be,bj as ke,bl as O,ag as G,eJ as Se,eK as we,b9 as ye,l as Ie,v as $}from"./vendor-B0vSnHFf.js";import{T as d,H as N}from"./BaseContext-DSwOqL9e.js";import{d as U,e as W,A as _e,w as Ce,x as ve,M as y}from"./index-CDdQlqFV.js";import{D as Fe}from"./DocTooltip-Dj0GZMgK.js";import{S as Me}from"./StylishText-CrpvZzAV.js";import{M as Ee,R as Ae}from"./Instance-Co8OMzcE.js";function ee({size:t=18,text:s,detail:r,link:a}){return e.jsx(Fe,{text:s,detail:r,link:a,children:e.jsx(se,{size:t})})}function P({children:t,variant:s,order:r,size:a,text:h,detail:m}){return e.jsxs(p,{children:[e.jsx(ie,{variant:s,order:r,size:a,children:t}),h&&e.jsx(ee,{text:h,detail:m})]})}function De(t){return t!=null&&t.part?[y.part,t==null?void 0:t.part.pk]:t!=null&&t.stockitem?[y.stockitem,t==null?void 0:t.stockitem.pk]:t!=null&&t.stocklocation?[y.stocklocation,t==null?void 0:t.stocklocation.pk]:t!=null&&t.supplierpart?[y.supplierpart,t==null?void 0:t.supplierpart.pk]:t!=null&&t.purchaseorder?[y.purchaseorder,t==null?void 0:t.purchaseorder.pk]:t!=null&&t.salesorder?[y.salesorder,t==null?void 0:t.salesorder.pk]:t!=null&&t.build?[y.build,t==null?void 0:t.build.pk]:[void 0,void 0]}function Ne(){var b;const{toggle:t,fullscreen:s}=ae(),[r,a]=le([]),[h,m]=X({key:"scan-history",defaultValue:[]}),[i,c]=f.useState([]),[S,g]=X({key:"input-selection",defaultValue:null});function M(){const l=w(i[0]);l&&C(l==null?void 0:l.ref,l==null?void 0:l.id)}const E=i.length===1&&((b=w(i[0]))==null?void 0:b.link)!=null;function A(){const l=w(i[0]);l&&E&&window.open(l.link,"_blank")}function _(){a.setState([]),m([]),c([])}function D(){a.setState(r.filter(l=>!i.includes(l.id))),c([])}function w(l){if(i.length===0)return;const u=r.find(j=>j.id===l);if((u==null?void 0:u.ref)!==void 0)return u}function C(l,u){U.post(W(_e.barcode),{barcode:l}).then(j=>{var F;if(!u)return;const x=w(i[0]);if(!x)return;x.link=(F=j.data)==null?void 0:F.url;const v=De(j.data);if(x.model=v[0],x.pk=v[1],x.model&&x.pk){let V=Ee[x.model];if(V&&V.api_endpoint){let K=W(V.api_endpoint,x.pk);U.get(K).then(z=>{x.instance=z.data;const te=r.findIndex(ne=>ne.id===u);a.setItem(te,x)}).catch(z=>{console.error("error while fetching instance data at",K),console.info(z)})}}else a.setState(r)}).catch(j=>{var x,v,F;((x=j.response)==null?void 0:x.status)===400&&((F=(v=j.response)==null?void 0:v.data)==null?void 0:F.plugin)==="None"||console.log("error while running barcode",j)})}function H(l){for(const u of l)a.append(u),C(u.ref,u.id);c(l.map(u=>u.id))}f.useEffect(()=>{r.length!==0&&m(r)},[r]),r.length===0&&h.length!=0&&a.setState(h);const R=[{value:"manually",label:o._({id:"pS7MTY"})},{value:"imageBarcode",label:o._({id:"29Om2/"})}],T=function(){switch(S){case"manually":return e.jsx(Re,{action:H});case"imageBarcode":return e.jsx(Te,{action:H});default:return e.jsx(I,{children:"No input selected"})}}(),n=()=>{const l=[...new Set(i.map(u=>{var j;return(j=r.find(x=>x.id===u))==null?void 0:j.model}).filter(u=>u!=null))];return l.length===0?e.jsxs(p,{gap:0,children:[e.jsx(de,{color:"orange"}),e.jsx(d,{id:"dQStih"})]}):l.length>1?e.jsxs(p,{gap:0,children:[e.jsx(he,{color:"orange"}),e.jsx(d,{id:"Oik3bo"})]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{fz:"sm",c:"dimmed",children:e.jsx(d,{id:"RlLl3G",values:{0:l[0]}})}),e.jsx(p,{children:e.jsx(k,{onClick:Ce,title:o._({id:"wBMjJ2"}),variant:"default",children:e.jsx(xe,{})})})]})};return e.jsxs(e.Fragment,{children:[e.jsxs(p,{justify:"space-between",children:[e.jsxs(p,{justify:"left",children:[e.jsx(Me,{children:e.jsx(d,{id:"T2Wq4D"})}),e.jsx(ee,{text:o._({id:"cXiEKg"})})]}),e.jsx(Y,{onClick:t,size:"sm",variant:"subtle",title:o._({id:"70W2+l"}),children:s?e.jsx(oe,{}):e.jsx(re,{})})]}),e.jsx(q,{h:"md"}),e.jsxs(Q,{maw:"100%",children:[e.jsx(Q.Col,{span:4,children:e.jsxs(B,{children:[e.jsxs(B,{gap:"xs",children:[e.jsxs(p,{justify:"space-between",children:[e.jsx(P,{order:3,text:o._({id:"qBZttg"}),children:e.jsx(d,{id:"XU5AOg"})}),e.jsx(Z,{value:S,onChange:g,data:R,searchable:!0,placeholder:o._({id:"kY/87m"}),nothingFoundMessage:o._({id:"ow3fug"})})]}),T]}),e.jsxs(B,{gap:0,children:[e.jsx(P,{order:3,text:o._({id:"66J/c0"}),children:e.jsx(d,{id:"bwRvnp"})}),i.length===0?e.jsx(I,{children:e.jsx(d,{id:"bX1aQ5"})}):e.jsxs(e.Fragment,{children:[e.jsx(I,{children:e.jsx(d,{id:"sQhVFe",values:{0:i.length}})}),e.jsx(I,{fz:"sm",c:"dimmed",children:e.jsx(d,{id:"U+sonC"})}),e.jsxs(p,{children:[e.jsx(k,{color:"red",onClick:D,title:o._({id:"cnGeoo"}),variant:"default",children:e.jsx(L,{})}),e.jsx(k,{onClick:M,disabled:i.length>1,title:o._({id:"H8H7u6"}),variant:"default",children:e.jsx(ce,{})}),e.jsx(k,{onClick:A,disabled:!E,title:o._({id:"sliuzR"}),variant:"default",children:e.jsx(ue,{})})]}),e.jsx(n,{})]})]})]})}),e.jsxs(Q.Col,{span:8,children:[e.jsxs(p,{justify:"space-between",children:[e.jsx(P,{order:3,text:o._({id:"mM7dgZ"}),detail:o._({id:"s9lCxX"}),children:e.jsx(d,{id:"0caMy7"})}),e.jsx(k,{color:"red",onClick:_,variant:"default",title:o._({id:"GAgzAK"}),children:e.jsx(L,{})})]}),e.jsx(He,{data:r,selection:i,setSelection:c})]})]})]})}function He({data:t,selection:s,setSelection:r}){const a=i=>r(c=>c.includes(i)?c.filter(S=>S!==i):[...c,i]),h=()=>r(i=>i.length===t.length?[]:t.map(c=>c.id)),m=f.useMemo(()=>t.map(i=>{var c;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(J,{checked:s.includes(i.id),onChange:()=>a(i.id)})}),e.jsx("td",{children:i.pk&&i.model&&i.instance?e.jsx(Ae,{model:i.model,instance:i.instance}):i.ref}),e.jsx("td",{children:i.model}),e.jsx("td",{children:i.source}),e.jsx("td",{children:(c=i.timestamp)==null?void 0:c.toString()})]},i.id)}),[t,s]);return t.length===0?e.jsx(I,{children:e.jsx(d,{id:"nB43gC"})}):e.jsx(fe,{children:e.jsxs(je,{miw:800,verticalSpacing:"sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:pe(40)},children:e.jsx(J,{onChange:h,checked:s.length===t.length,indeterminate:s.length>0&&s.length!==t.length})}),e.jsx("th",{children:e.jsx(d,{id:"HX5SVx"})}),e.jsx("th",{children:e.jsx(d,{id:"+zy2Nq"})}),e.jsx("th",{children:e.jsx(d,{id:"wdxz7K"})}),e.jsx("th",{children:e.jsx(d,{id:"PvB8gr"})})]})}),e.jsx("tbody",{children:m})]})})}function Re({action:t}){const[s,r]=f.useState("");function a(){if(s==="")return;const h={id:$(),ref:s,data:{item:s},timestamp:new Date,source:"manually"};t([h]),r("")}return e.jsxs(e.Fragment,{children:[e.jsxs(p,{children:[e.jsx(me,{placeholder:o._({id:"mPrJo6"}),value:s,onChange:h=>r(h.currentTarget.value),onKeyDown:ge([["Enter",a]])}),e.jsx(k,{onClick:a,w:16,variant:"default",children:e.jsx(be,{})})]}),ve]})}function Te({action:t}){const[s,r]=f.useState(null),[a,h]=X({key:"camId",defaultValue:null}),[m,i]=f.useState([]),[c,S]=f.useState(null),[g,M]=f.useState(!1),[E,A]=f.useState(!1),_=ke();let D="";f.useEffect(()=>{r(new N("reader")),N.getCameras().then(n=>{n!=null&&n.length&&i(n)})},[]),f.useEffect(()=>{a&&S(a.id)},[a]),f.useEffect(()=>{g&&_==="hidden"?(T(),A(!0)):E&&_==="visible"&&(R(),A(!1))},[_]);function w(n){if(s==null||s.pause(),n===D){s==null||s.resume();return}D=n,t([{id:$(),ref:n,data:n,timestamp:new Date,source:"imageBarcode"}]),s==null||s.resume()}function C(n){n!="QR code parse error, error = NotFoundException: No MultiFormat Readers were able to detect the code."&&console.warn(`Code scan error = ${n}`)}function H(){N.getCameras().then(n=>{n!=null&&n.length&&h(n[0])}).catch(n=>{O({title:o._({id:"UHot+L"}),message:n,color:"red",icon:e.jsx(G,{})})})}function R(){a&&s&&!g&&(s.start(a.id,{fps:10,qrbox:{width:250,height:250}},n=>{w(n)},n=>{C(n)}).catch(n=>{O({title:o._({id:"bR26mb"}),message:n,color:"red",icon:e.jsx(G,{})})}),M(!0))}function T(){s&&g&&(s.stop().catch(n=>{O({title:o._({id:"fvJQqd"}),message:n,color:"red",icon:e.jsx(G,{})})}),M(!1))}return f.useEffect(()=>{if(c===null||c===(a==null?void 0:a.id))return;const n=m.find(b=>b.id===c);s&&g?s.stop().then(()=>{h(n),s.start(n.id,{fps:10,qrbox:{width:250,height:250}},b=>{w(b)},b=>{C(b)})}):h(n)},[c]),e.jsxs(B,{gap:"xs",children:[e.jsxs(p,{gap:"xs",children:[e.jsx(Z,{value:c,onChange:S,data:m.map(n=>({value:n.id,label:n.label})),size:"sm"}),g?e.jsx(k,{onClick:T,title:o._({id:"yFRXH8"}),variant:"default",children:e.jsx(Se,{})}):e.jsx(k,{onClick:R,title:o._({id:"m3BKG+"}),disabled:!a,variant:"default",children:e.jsx(we,{})}),e.jsx(q,{style:{flex:1}}),e.jsx(ye,{color:g?"green":"orange",children:g?o._({id:"CMQ09J"}):o._({id:"Fg9r/3"})})]}),e.jsx(Ie,{px:0,id:"reader",w:"100%",mih:"300px"}),!a&&e.jsx(Y,{onClick:H,children:e.jsx(d,{id:"QuNKRX"})})]})}export{Ne as default};
